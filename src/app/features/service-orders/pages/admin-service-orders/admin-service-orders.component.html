<div class="md:p-4 bg-white dark:bg-slate-900 min-h-full rounded-lg shadow-md">
  <p-fieldset
    [toggleable]="true"
    [collapsed]="true"
    styleClass="mb-6 filter-fieldset"
  >
    <ng-template pTemplate="header">
      <div class="flex items-center gap-2">
        <i class="pi pi-filter"></i>
        <span class="font-bold text-md">Filtros de Pesquisa</span>
      </div>
    </ng-template>

    <form [formGroup]="filterForm">
      <div
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-x-6 gap-y-6 p-fluid"
      >
        <div>
          <label
            for="contractNumber"
            class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5"
            >N¬∫ Contrato</label
          >
          <p-inputNumber
            inputId="contractNumber"
            formControlName="contractNumber"
            mode="decimal"
            [useGrouping]="false"
            placeholder="Digite o n√∫mero"
          ></p-inputNumber>
        </div>
        <div>
          <label
            for="clientName"
            class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5"
            >Nome do Cliente</label
          >
          <input
            id="clientName"
            type="text"
            pInputText
            formControlName="clientName"
            placeholder="Busque por nome"
          />
        </div>
        <div>
          <label
            for="technicianId"
            class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5"
            >T√©cnico</label
          >
          <p-select
            inputId="technicianId"
            [options]="technicianOptions"
            formControlName="technicianId"
            placeholder="Todos"
            optionLabel="label"
            optionValue="value"
            [showClear]="true"
            class="w-full"
            panelStyleClass="w-full"
            appendTo="body"
          />
        </div>

        <div>
          <label
            for="startDate"
            class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5"
            >Agendado De</label
          >
          <p-datepicker
            inputId="startDate"
            formControlName="startDate"
            dateFormat="dd/mm/yy"
            dataType="string"
            [showIcon]="true"
            placeholder="dd/mm/aaaa"
            showClear
            appendTo="body"
          />
        </div>
        <div>
          <label
            for="endDate"
            class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5"
            >Agendado At√©</label
          >
          <p-datepicker
            inputId="endDate"
            formControlName="endDate"
            dateFormat="dd/mm/yy"
            dataType="string"
            [showIcon]="true"
            placeholder="dd/mm/aaaa"
            showClear
            appendTo="body"
          />
        </div>
        <div>
          <label
            for="periods"
            class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5"
            >Per√≠odos</label
          >
          <p-multiSelect
            inputId="periods"
            [options]="periodOptions"
            formControlName="periods"
            placeholder="Todos"
            optionLabel="label"
            optionValue="value"
            [showClear]="true"
            class="w-full"
            panelStyleClass="w-full"
          />
        </div>
        <div>
          <label
            for="typesOfOS"
            class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5"
            >Tipo de OS</label
          >
          <p-multiSelect
            inputId="typesOfOS"
            [options]="serviceOrderTypeOptions"
            formControlName="typesOfOS"
            placeholder="Todos"
            optionLabel="label"
            optionValue="value"
            [showClear]="true"
            class="w-full"
            panelStyleClass="w-full"
          />
        </div>
        <div>
          <label
            for="subTypeOs"
            class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5"
            >Sub Tipo da OS</label
          >
          <p-multiSelect
            inputId="subTypeOs"
            [options]="subStatusOptions"
            formControlName="subTypeOs"
            placeholder="Todos"
            optionLabel="label"
            optionValue="value"
            [showClear]="true"
            class="w-full"
            panelStyleClass="w-full"
          />
        </div>
        <div>
          <label
            for="statuses"
            class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5"
            >Status da OS</label
          >
          <p-multiSelect
            inputId="statuses"
            [options]="statusOptions"
            formControlName="statuses"
            placeholder="Todos"
            optionLabel="label"
            optionValue="value"
            [showClear]="true"
            class="w-full"
            panelStyleClass="w-full"
          />
        </div>
        <div>
          <label
            for="cities"
            class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5"
            >Cidades</label
          >
          <p-multiSelect
            inputId="cities"
            [options]="cityOptions"
            formControlName="cities"
            placeholder="Todas"
            optionLabel="label"
            optionValue="value"
            [showClear]="true"
            class="w-full"
            panelStyleClass="w-full"
          />
        </div>
      </div>

      <div
        class="flex justify-between items-center gap-3 mt-6 pt-4 border-t border-slate-200 dark:border-slate-700"
      >
        <div class="flex items-center gap-2">
          <p-button
            label="OS Expiradas"
            icon="pi pi-exclamation-triangle"
            outlined
            text
            severity="danger"
            [badge]="expiredOsCount.toString()"
            [badgeSeverity]="'danger'"
            (click)="showExpiredOs()"
          />
          <p-button
            label="Os Em Produ√ß√£o"
            icon="pi pi-list"
            outlined
            text
            severity="info"
            class="ml-2"
            (click)="showAllOs()"
          />
        </div>
        <div class="flex items-center gap-3">
          <button
            pButton
            type="button"
            label="Limpar Filtros"
            icon="pi pi-filter-slash"
            class="p-button-outlined p-button-secondary"
            (click)="clearFilters()"
          ></button>
          <button
            pButton
            type="button"
            label="Pesquisar"
            icon="pi pi-search"
            class="p-button-outlined p-button-primary"
            (click)="applyFilters()"
          ></button>
        </div>
      </div>
    </form>
  </p-fieldset>

  <div *ngIf="!isLoading; else loadingTemplate">
    <form [formGroup]="osGroup" class="p-fluid">
      <p-table
        #dt
        [rowTrackBy]="trackById"
        dataKey="id"
        [value]="dataSource"
        [loading]="isLoading"
        styleClass="text-sm"
        [paginator]="true"
        [rows]="rows"
        [totalRecords]="totalRecords"
        (onPage)="onTableLazyLoad($event)"
        [lazy]="true"
        [rowsPerPageOptions]="[20, 30, 50, 100]"
        stripedRows
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} OS"
        formArrayName="orders"
      >
        <ng-template #header>
          <tr>
            <th>Contrato</th>
            <th>Cliente / Endere√ßo</th>
            <th>Tipo OS</th>
            <th>Sub Tipo</th>
            <th class="w-46">Data Agend.</th>
            <th class="w-24">Per√≠odo</th>
            <th class="w-48">T√©cnico</th>
            <th class="w-32">In√≠cio</th>
            <th class="w-32">Fim</th>
            <th class="w-20">Dura√ß√£o</th>
            <th class="w-50">Status</th>
            <th style="width: 12rem" class="text-center">A√ß√µes</th>
          </tr>
        </ng-template>
        <ng-template #body let-os let-i="rowIndex">
          <tr [formGroupName]="i">
            <td>{{ os.contractNumber }}</td>

            <td>
              <div class="os-card">
                <!-- HEADER -->
                <div class="os-card-header">
                  <div class="client-name">
                    <span class="client-avatar">üë§</span>
                    <span>{{ os.clientName }}</span>
                  </div>

                  <!-- TAG DE VENDA -->

                  <p-tag
                    *ngIf="
                      os.typeOfOs === 'INSTALLATION' && os.responsibleSeller
                    "
                    value="LOJA ‚Ä¢ VENDA"
                    severity="success"
                    icon="pi pi-shopping-cart"
                    rounded
                  ></p-tag>
                </div>

                <!-- ENDERE√áO -->
                <div class="os-card-row address">
                  <strong>Endere√ßo:</strong> {{ os.address }}
                </div>

                <!-- GRID DE INFO -->
                <div class="os-card-grid">
                  <div class="info-item">
                    <span class="label">üè∑Ô∏è Tipo do Cliente:</span>
                    <span class="value">{{
                      getClientTypeLabel(os.clientType)
                    }}</span>
                  </div>

                  <div class="info-item">
                    <span class="label">üèôÔ∏è Cidade:</span>
                    <span class="value">{{ getCitiesLabel(os.city) }}</span>
                  </div>

                  <div class="info-item">
                    <span class="label">üìû Celular:</span>
                    <span class="value">{{ os.phone1 | phones }}</span>
                  </div>

                  <div class="info-item" *ngIf="os.responsibleSeller">
                    <span class="label">üí∏ Vendedor:</span>
                    <span class="value">{{ os.responsibleSeller }}</span>
                  </div>
                </div>

                <!-- ALERTA OS DE VENDA -->
                <div
                  *ngIf="os.typeOfOs === 'INSTALLATION' && os.responsibleSeller"
                  class="sale-alert"
                  pTooltip="
        üü° Esta √© uma Ordem de Servi√ßo de VENDA.
        Ap√≥s a execu√ß√£o, o financeiro ser√° lan√ßado automaticamente.
        Esta OS n√£o pode ser exclu√≠da, apenas reagendada.
      "
                  tooltipPosition="top"
                >
                  ‚ö†Ô∏è OS tratada de forma especial
                </div>
              </div>
            </td>

            <td>{{ getTypeOfOsLabel(os.typeOfOs) }}</td>
            <td>{{ getSubTypeOsLabel(os.subTypeOs) }}</td>
            <td>
              <p-datepicker
                *ngIf="
                  !(os.typeOfOs === 'INSTALLATION' && os.responsibleSeller)
                "
                formControlName="scheduleDate"
                dateFormat="dd/mm/yy"
                dataType="string"
                appendTo="body"
                styleClass="min-w-[7rem]"
                fluid
                [disabledDays]="[0]"
                id="scheduleDate-{{ i }}"
              />
            </td>
            <td>
              <p-select
                *ngIf="
                  !(os.typeOfOs === 'INSTALLATION' && os.responsibleSeller)
                "
                [options]="periodOptions"
                formControlName="period"
                appendTo="body"
                styleClass="min-w-full max-w-[100%]"
              />
            </td>
            <td>
              <p-select
                *ngIf="
                  !(os.typeOfOs === 'INSTALLATION' && os.responsibleSeller)
                "
                [options]="technicianOptions"
                formControlName="technician"
                optionLabel="label"
                optionValue="value"
                appendTo="body"
                styleClass="min-w-[170px] max-w-[170px]"
                id="technician"
                showClear
              />
            </td>
            <td>
              <p-datepicker
                *ngIf="
                  !(os.typeOfOs === 'INSTALLATION' && os.responsibleSeller)
                "
                formControlName="startOfOs"
                styleClass="min-w-[5rem]"
                [timeOnly]="true"
                dataType="string"
                dateFormat="HH:mm"
                hourFormat="24"
                appendTo="body"
                showClear
              />
            </td>
            <td>
              <p-datepicker
                *ngIf="
                  !(os.typeOfOs === 'INSTALLATION' && os.responsibleSeller)
                "
                formControlName="endOfOs"
                styleClass="min-w-[5rem]"
                [timeOnly]="true"
                dataType="string"
                dateFormat="HH:mm"
                hourFormat="24"
                appendTo="body"
                showClear
              />
            </td>
            <td>
              <ng-container
                *ngIf="
                  !(os.typeOfOs === 'INSTALLATION' && os.responsibleSeller)
                "
              >
                {{ os.durationOfOs | formatDuration }}
              </ng-container>
            </td>

            <td>
              <!-- STATUS EDIT√ÅVEL (N√ÉO VENDA) -->
              <p-select
                *ngIf="
                  !(os.typeOfOs === 'INSTALLATION' && os.responsibleSeller)
                "
                [options]="statusOptions"
                formControlName="status"
                optionLabel="label"
                optionValue="value"
                appendTo="body"
                class="min-w-full"
              >
                <ng-template let-option pTemplate="item">
                  <div
                    class="status-option"
                    [ngClass]="{
                      'status-executado':
                        option.value === ServiceOrderStatus.EXECUTED,
                      'status-andamento':
                        option.value === ServiceOrderStatus.IN_PRODUCTION,
                      'status-cancelado':
                        option.value === ServiceOrderStatus.CANCELED,
                      'status-reagendado':
                        option.value === ServiceOrderStatus.RESCHEDULED
                    }"
                  >
                    {{ option.label }}
                  </div>
                </ng-template>
              </p-select>

              <div
                *ngIf="os.typeOfOs === 'INSTALLATION' && os.responsibleSeller"
                class="flex items-center justify-between gap-4"
              >
                <span
                  class="px-3 py-1 rounded-full text-sm font-semibold whitespace-nowrap"
                  [ngClass]="{
                    'status-executado':
                      os.status === ServiceOrderStatus.EXECUTED,
                    'status-andamento':
                      os.status === ServiceOrderStatus.IN_PRODUCTION,
                    'status-cancelado':
                      os.status === ServiceOrderStatus.CANCELED,
                    'status-reagendado':
                      os.status === ServiceOrderStatus.RESCHEDULED
                  }"
                >
                  {{ getStatusLabel(os.status) }}
                </span>

                <!-- BOT√ÉO -->
                <button
                  pButton
                  size="large"
                  severity="contrast"
                  icon="pi pi-angle-right"
                  [rounded]="true"
                  pTooltip="Iniciar OS de Venda"
                  [raised]="true"
                  (click)="openShopOsDialog(os)"
                ></button>
              </div>
            </td>

            <td>
              <div class="flex flex-col items-center justify-center gap-2">
                <div>
                  <button
                    type="button"
                    rounded
                    pButton
                    (click)="openUnproductiveVisitDialog(os)"
                    icon="pi pi-flag"
                    text
                    pTooltip="Visita Improdutiva"
                    tooltipPosition="left"
                  ></button>
                  <button
                    type="button"
                    pButton
                    (click)="openHelperTechDialog(os)"
                    icon="pi pi-calendar-plus"
                    rounded
                    text
                    pTooltip="Ajuda T√©cnica"
                    tooltipPosition="left"
                  ></button>
                </div>

                <div>
                  <button
                    type="button"
                    pButton
                    icon="pi pi-pencil"
                    class="p-button-rounded p-button-text p-button-warning"
                    pTooltip="Editar OS"
                    (click)="openEditTechDialog(os)"
                    tooltipPosition="left"
                  ></button>
                  <button
                    type="button"
                    pButton
                    (click)="openObservationTechDialog(os)"
                    [pTooltip]="
                      os.observation ? os.observation : 'Sem Observa√ß√£o'
                    "
                    icon="pi pi-info-circle"
                    class="p-button-rounded p-button-text p-button-info"
                    [severity]="os.observation ? 'info' : 'warn'"
                  ></button>
                  <button
                    type="button"
                    pButton
                    icon="pi pi-trash"
                    class="p-button-rounded p-button-text p-button-danger"
                    pTooltip="Excluir OS"
                    (click)="confirmDeleteServiceOrder($event, os)"
                    tooltipPosition="left"
                  ></button>
                </div>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </form>
  </div>
</div>
<p-toast />

<ng-template #loadingTemplate>
  <div class="flex justify-center items-center p-8">
    <i class="pi pi-spin pi-spinner" style="font-size: 2rem"></i>
    <span class="ml-2">Carregando Ordens de Servi√ßo...</span>
  </div>
</ng-template>

<p-dialog
  dismissableMask="true"
  draggable="false"
  header="Visita Improdutiva"
  [modal]="true"
  [(visible)]="isUnproductiveVisitDialogVisible"
  [style]="{ width: '35rem' }"
>
  <ng-container
    *ngIf="isUnproductiveVisitDialogVisible && selectedServiceOrder"
  >
    <app-unproductive-visits
      [technicians]="technicianOptions"
      [serviceOrder]="selectedServiceOrder"
    ></app-unproductive-visits>
  </ng-container>
</p-dialog>

<p-dialog
  dismissableMask="true"
  draggable="false"
  header="Ajuda T√©cnica"
  [modal]="true"
  [(visible)]="isHelperTechDialogVisible"
  [style]="{ width: '30rem' }"
>
  @if(isHelperTechDialogVisible && selectedServiceOrder){
  <app-helper-tech
    #helperTechDialog
    (eventHelper)="onHelperSuccess()"
    [technicians]="technicianOptions"
    [serviceOrder]="selectedServiceOrder"
  ></app-helper-tech>
  }
</p-dialog>

<p-dialog
  dismissableMask="true"
  draggable="false"
  header="Editar OS"
  [modal]="true"
  [(visible)]="isEditingTechDialogVisible"
  [style]="{ width: '50rem' }"
>
  @if(selectedServiceOrder && isEditingTechDialogVisible){
  <app-edit
    #editOS
    (eventEdit)="onEditSuccess()"
    [serviceOrder]="selectedServiceOrder"
  ></app-edit>
  }
</p-dialog>

<p-dialog
  dismissableMask="true"
  draggable="false"
  header="Editar OS"
  [modal]="true"
  [(visible)]="isPostingObeservationTechDialogVisible"
  [style]="{ width: '30rem' }"
>
  @if(selectedServiceOrder && isPostingObeservationTechDialogVisible){

  <app-observation
    (eventObservation)="onObservationSuccess()"
    [serviceOrder]="selectedServiceOrder"
  ></app-observation>
  }
</p-dialog>

<p-confirmdialog />

<p-dialog
  header="üöÄ Iniciar OS de Venda"
  *ngIf="shopOsForm"
  [(visible)]="isShopOsDialogVisible"
  [modal]="true"
  [style]="{ width: '34rem' }"
  [closable]="false"
  [focusOnShow]="false"
  [draggable]="false"
>
  <form [formGroup]="shopOsForm" class="p-fluid">
    <!-- Data + Per√≠odo -->
    <div class="grid grid-cols-2 gap-3 mb-4">
      <div>
        <label class="text-sm font-medium mb-1 block">
          üìÖ Data de Agendamento
        </label>
        <p-datepicker
          formControlName="scheduleDate"
          appendTo="body"
          showIcon
          appendTo="body"
          readonlyInput
        />
      </div>

      <div>
        <label class="text-sm font-medium mb-1 block"> ‚è∞ Per√≠odo </label>
        <p-select
          [options]="periodOptions"
          formControlName="period"
          appendTo="body"
        />
      </div>
    </div>

    <!-- T√©cnico -->
    <div class="mb-4">
      <label class="text-sm font-medium mb-1 block">
        üë∑ T√©cnico Respons√°vel
      </label>
      <p-select
        [options]="technicianOptions"
        optionLabel="label"
        optionValue="value"
        formControlName="technician"
        showClear
        appendTo="body"
      />
    </div>

    <!-- Hor√°rios -->
    <!-- Hor√°rios -->
    <div class="grid grid-cols-2 gap-3 mb-2">
      <!-- In√≠cio -->
      <div>
        <label class="text-sm font-medium mb-1 block"> ‚ñ∂Ô∏è In√≠cio </label>
        <input
          type="time"
          class="p-inputtext w-full"
          [readonly]="false"
          [value]="shopOsForm.get('startOfOs')!.value"
          (input)="
            shopOsForm.get('startOfOs')!.setValue($any($event.target).value)
          "
        />
      </div>

      <!-- Fim -->
      <div>
        <label class="text-sm font-medium mb-1 block"> ‚èπ Fim </label>
        <input
          type="time"
          class="p-inputtext w-full"
          [readonly]="!canEditEndOfOs"
          [value]="shopOsForm.get('endOfOs')!.value"
          (input)="
            shopOsForm.get('endOfOs')!.setValue($any($event.target).value)
          "
        />
      </div>
    </div>

    <div
      class="mt-3 p-3 rounded-md bg-yellow-50 text-yellow-800 text-sm flex gap-2 items-start"
    >
      <i class="pi pi-info-circle mt-0.5"></i>
      <span>
        Esta OS √© do tipo <strong>Venda</strong>. As altera√ß√µes ser√£o aplicadas
        somente ap√≥s a confirma√ß√£o.
      </span>
    </div>

    <div class="flex justify-end gap-2 mt-5">
      <button
        pButton
        type="button"
        label="Cancelar"
        icon="pi pi-times"
        class="p-button-text"
        (click)="isShopOsDialogVisible = false"
      ></button>

      <button
        pButton
        type="button"
        label="Confirmar"
        icon="pi pi-check"
        class="p-button-success"
        (click)="confirmShopOs()"
        [disabled]="shopOsForm.invalid"
      ></button>
    </div>
  </form>
</p-dialog>
