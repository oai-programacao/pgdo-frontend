<!-- Container geral -->
<div class="md:p-6 bg-white dark:bg-slate-900 rounded-lg shadow-md">
  <div
    class="flex flex-col items-center gap-6 mx-auto bg-white p-6 rounded-2xl shadow border border-gray-200"
  >
    <!-- Campos de busca -->
    <p-select
      [options]="clientTypeOptions"
      [(ngModel)]="clientType"
      placeholder="Selecione o tipo"
      (ngModelChange)="onClientTypeChange()"
      optionLabel="label"
      optionValue="value"
      class="w-full sm:w-3/4 md:w-2/3 lg:w-1/2"
    />

    @if(clientType === 'PF'){
    <input
      type="text"
      pInputText
      placeholder="CPF do Cliente"
      [(ngModel)]="cpfCnpj"
      mask="000.000.000-00"
      unmask="true"
      maxlength="14"
      [disabled]="!clientType"
      class="w-full sm:w-3/4 md:w-2/3 lg:w-1/2 py-3 px-4 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition"
    />
    } @if(clientType === 'PJ'){
    <input
      type="text"
      pInputText
      placeholder="CNPJ do Cliente"
      [(ngModel)]="cpfCnpj"
      mask="00.000.000/0000-00"
      unmask="true"
      maxlength="18"
      [disabled]="!clientType"
      class="w-full sm:w-3/4 md:w-2/3 lg:w-1/2 py-3 px-4 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition"
    />
    }

    <!-- Botão de consulta -->
    <div class="w-full sm:w-3/4 md:w-2/3 lg:w-1/2 flex justify-center">
      <p-button
        icon="pi pi-search"
        (onClick)="consultClient(); registerNewClient()"
        label="Consultar Cliente"
        severity="info"
        [disabled]="!cpfCnpj || !clientType"
        class="w-full sm:w-auto"
      />
    </div>

    <!-- Estados de carregamento e mensagens -->
    @if(isLoading){
    <div class="flex justify-center w-full py-4">
      <p-progress-spinner ariaLabel="isLoading" />
    </div>
    } @else if(!hasSearched){
    <div class="text-center text-gray-500">
      <p class="text-sm">Por favor, faça uma consulta.</p>
    </div>
    } @else if(!isLoading && hasSearched && (!dataClient || dataClient.length
    === 0)) {
    <div class="text-center text-gray-500">
      <p class="text-sm">Nenhum cliente encontrado.</p>
      <div class="mt-2">
        <p-button
          label="Registrar Novo Cliente"
          [outlined]="true"
          (onClick)="confirmToRegisterNewClient($event, cpfCnpj)"
        />
      </div>
    </div>
    } @else {

    <div class="flex flex-col gap-4 w-full">
      <div
        *ngFor="let client of dataClient; let i = index"
        class="grid grid-cols-1 lg:grid-cols-6 gap-4 p-6 bg-white border border-gray-200 rounded-xl shadow-sm hover:shadow-lg transition-all duration-300 w-full"
      >
        <!-- Nome -->
        <div class="min-w-[9.375rem] text-left lg:text-center">
          <span
            class="text-[11px] text-center text-gray-400 uppercase tracking-wider mb-1 block"
          >
            Nome
          </span>
          <span class="font-semibold text-center text-gray-800 truncate block">
            {{ clientType === "PJ" ? client.companyName : client.name }}
          </span>
        </div>

        <!-- Tipo do Plano -->
        <div class="min-w-[8rem] text-center text-left lg:text-center">
          <span
            class="text-[11px] text-center text-gray-400 uppercase tracking-wider mb-1 block"
          >
            CPF/CNPJ
          </span>
          <span class="text-gray-700 text-center font-medium truncate block">
            {{
              clientType === "PJ"
                ? client.cnpj || " - "
                : (client.cpf || " - " | cpfCnpj)
            }}
          </span>
        </div>

        <!-- Endereço -->
        <div class="min-w-[12.5rem] text-left lg:text-center">
          <span
            class="text-[11px] text-center text-gray-400 uppercase tracking-wider mb-1 block"
          >
            Endereço
          </span>
          <span class="text-gray-600 text-center font-medium truncate block">
            {{ client.addresses[0]?.street }},
            {{ client.addresses[0]?.number }},
            {{ client.addresses[0]?.neighborhood }},
            {{ client.addresses[0]?.city }}
          </span>
        </div>

        <!-- Telefone -->
        <div class="min-w-[10rem] text-left lg:text-center">
          <span
            class="text-[11px] text-gray-400 text-center uppercase tracking-wider mb-1 block"
          >
            Telefone
          </span>
          <span class="text-gray-700 text-center font-medium truncate block">
            {{ client.mobilePhone || " - " | phones }}
          </span>
        </div>

        <!-- Qtd. de Contrato -->
        <div class="min-w-[6.25rem] text-left lg:text-center">
          <span
            class="text-[11px] text-center text-gray-400 uppercase tracking-wider mb-1 block"
          >
            Qtd. de Contrato
          </span>
          <span class="text-gray-700 text-center font-medium truncate block">
            @if(client.contracts && client.contracts.length > 0) {
            {{ client.contracts.length }}
            } @else { 0 }
          </span>
        </div>

        <!-- Botões -->
        <div
          class="flex items-center justify-center lg:justify-end gap-2 lg:mt-0"
        >
          <p-button
            icon="pi pi-plus"
            [rounded]="true"
            [text]="true"
            pTooltip="Criar Novo Contrato"
            severity="success"
            (onClick)="createNewContractVisible(client)"
          />
          <p-button
            icon="pi pi-eye"
            [rounded]="true"
            [text]="true"
            pTooltip="Ver Detalhes"
            severity="info"
            (onClick)="openWatchDataDialog(client)"
          />
          <p-button
            icon="pi pi-file"
            [rounded]="true"
            [text]="true"
            pTooltip="Visualizar Contratos"
            severity="secondary"
            (onClick)="viewContractsDialogVisible(client)"
          />
        </div>
      </div>
    </div>
    }
  </div>
</div>

<p-toast />
<p-confirmpopup />

@if (createNewContractDialog) {
<p-dialog
  [(visible)]="createNewContractDialog"
  header="Cadastrar Novo Contrato"
  [modal]="true"
  [draggable]="false"
  position="top"
  [resizable]="false"
  [style]="{ width: '80vw', height: '60vh' }"
>
  <app-create-contract
    [isPJorPF]="clientType"
    [clientData]="dataClient"
    (contractCreated)="createdContract()"
  ></app-create-contract>
</p-dialog>
} @if (viewContractsDialog) {
<p-dialog
  [(visible)]="viewContractsDialog"
  header="Visualizar Contratos"
  [modal]="true"
  [draggable]="false"
  position="top"
  [resizable]="false"
  (onHide)="onDialogHide()"
  [style]="{ width: '40rem', height: '70vh' }"
>
  @if(viewContractsDialog){

  <ng-container>
    <app-view-contracts
      [clientData]="dataClient"
      [isPJorPF]="clientType"
    ></app-view-contracts>
  </ng-container>
  }
</p-dialog>
}



@if(showDataClientDialog){
  <p-dialog
    header="Visualizar Dados do Cliente"
    [(visible)]="showDataClientDialog"
    [modal]="true"
    [closable]="true"
    [dismissableMask]="false"
    [style]="{ width: '600px', minWidth: '500px' }"
    [draggable]="false"
  >
<div class="w-full p-6 bg-white dark:bg-slate-900 rounded-xl shadow-md">
  <p-fieldset legend="Dados do Cliente" [toggleable]="true" [collapsed]="false">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-5 text-sm">
      <!-- Nome -->
      <div class="flex flex-col justify-center">
        <span class="text-xs font-bold text-slate-500 mb-1 md:text-left text-center uppercase tracking-wide">Nome</span>
        <span class="text-base text-slate-900 font-medium md:text-left text-center truncate">
          {{ clientType === 'PJ' ? dataClient[0]?.companyName : dataClient[0]?.name }}
        </span>
      </div>
      <!-- CPF/CNPJ -->
      <div class="flex flex-col justify-center">
        <span class="text-xs font-bold text-slate-500 mb-1 md:text-left text-center uppercase tracking-wide">CPF/CNPJ</span>
        <span class="text-base text-slate-900 font-medium md:text-left text-center truncate">
          {{ clientType === 'PJ' ? dataClient[0]?.cnpj : dataClient[0]?.cpf | cpfCnpj }}
        </span>
      </div>
      <!-- Telefone -->
      <div class="flex flex-col justify-center">
        <span class="text-xs font-bold text-slate-500 mb-1 md:text-left text-center uppercase tracking-wide">Telefone</span>
        <span class="text-base text-slate-900 font-medium md:text-left text-center truncate">
          {{ dataClient[0]?.mobilePhone | phones }}
        </span>
      </div>
      <!-- Endereço -->
      <div class="md:col-span-2 flex flex-col justify-center">
        <span class="text-xs font-bold text-slate-500 mb-1 md:text-left text-center uppercase tracking-wide">Endereço</span>
        <span class="text-base text-slate-900 font-medium md:text-left text-center leading-relaxed truncate">
          {{ dataClient[0]?.addresses[0]?.street }},
          {{ dataClient[0]?.addresses[0]?.number }},
          {{ dataClient[0]?.addresses[0]?.neighborhood }},
          {{ dataClient[0]?.addresses[0]?.city }}
        </span>
      </div>
      <!-- Qtd. Contratos -->
      <div class="flex flex-col justify-center">
        <span class="text-xs font-bold text-slate-500 mb-1 md:text-left text-center uppercase tracking-wide">Qtd. Contratos</span>
        <span class="text-base text-slate-900 font-medium md:text-left text-center">
          {{ dataClient[0]?.contracts?.length || 0 }}
        </span>
      </div>
    </div>
  </p-fieldset>
</div>

  </p-dialog>
}

<p-toast />
