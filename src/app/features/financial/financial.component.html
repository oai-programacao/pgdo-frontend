<div class="page">
  <div class="wrapper">

    <!-- Brand bar -->
    <div class="brand-bar">
      <div class="brand-dot"></div>
      <span class="brand-name">Geração de Carnê de Clientes</span>
    </div>

    <div class="card">
      <div class="card-strip"></div>

      <!-- Header -->
      <div class="card-header">
        <div class="icon-box">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75"
            stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
            <line x1="16" y1="13" x2="8" y2="13"/>
            <line x1="16" y1="17" x2="8" y2="17"/>
          </svg>
        </div>
        <div class="header-text">
          <h1>Consulta de Carnê</h1>
          <p>Geração de PDF via Santander</p>
        </div>
      </div>

      <!-- Body -->
      <div class="card-body">

        <div class="info-banner">
          <svg class="info-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <line x1="12" y1="8" x2="12" y2="12"/>
            <line x1="12" y1="16" x2="12.01" y2="16"/>
          </svg>
          <span>Sincronize o cliente pelo CPF para carregar os contratos automaticamente, ou informe o número do contrato manualmente.</span>
        </div>

        <!-- ── Modo Tabs ── -->
        <div class="tabs">
          <button class="tab" [class.active]="mode === 'sync'" (click)="setMode('sync')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <polyline points="23 4 23 10 17 10"/>
              <polyline points="1 20 1 14 7 14"/>
              <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
            </svg>
            Sincronizar Cliente
          </button>
          <button class="tab" [class.active]="mode === 'manual'" (click)="setMode('manual')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
              <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
            </svg>
            Contrato Manual
          </button>
        </div>

        <!-- ══ MODO SINCRONIZAR ══ -->
        <div *ngIf="mode === 'sync'">

          <!-- Step 1: CPF -->
          <div class="step">
            <div class="step-label">
              <span class="step-number">1</span>
              <span class="field-label">CPF do Cliente</span>
            </div>
            <div class="input-row">
              <div class="input-wrap">
                <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                  stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                  <circle cx="12" cy="7" r="4"/>
                </svg>
                <input
                  type="text"
                  [(ngModel)]="cpf"
                  placeholder="000.000.000-00"
                  autocomplete="off"
                  class="contract-input"
                  [disabled]="syncLoading || !!clientId"
                  (keydown.enter)="syncClient()"
                />
              </div>
              <button class="btn-action" (click)="syncClient()"
                [disabled]="syncLoading || !!clientId">
                <svg *ngIf="syncLoading" class="spinner" viewBox="0 0 24 24" fill="none">
                  <circle cx="12" cy="12" r="10" stroke="rgba(255,255,255,0.3)" stroke-width="3"/>
                  <path fill="white" d="M4 12a8 8 0 018-8v8z"/>
                </svg>
                <span>{{ syncLoading ? 'Sincronizando...' : 'Sincronizar' }}</span>
              </button>
            </div>
          </div>

          <!-- Step 2: Contrato (dropdown) -->
          <div class="step" [class.disabled]="!clientId">
            <div class="step-label">
              <span class="step-number">2</span>
              <span class="field-label">Selecione o Contrato</span>
              <span class="step-reset" *ngIf="clientId" (click)="resetSync()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                  stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="1 4 1 10 7 10"/>
                  <path d="M3.51 15a9 9 0 1 0 .49-3.51"/>
                </svg>
                Trocar cliente
              </span>
            </div>

            <div class="input-wrap" *ngIf="contracts.length > 0">
              <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
              </svg>
              <select class="contract-input contract-select" [(ngModel)]="selectedContract"
                [disabled]="!clientId">
                <option value="">Selecione um contrato...</option>
                <option *ngFor="let c of contracts" [value]="c.contractCode">
                  {{ c.contractCode }} — {{ c.planName }}
                </option>
              </select>
            </div>

            <div class="empty-contracts" *ngIf="clientId && contracts.length === 0 && !contractsLoading">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"
                stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="12"/>
                <line x1="12" y1="16" x2="12.01" y2="16"/>
              </svg>
              Nenhum contrato encontrado para este cliente.
            </div>

            <div class="loading-contracts" *ngIf="contractsLoading">
              <svg class="spinner-sm" viewBox="0 0 24 24" fill="none">
                <circle cx="12" cy="12" r="10" stroke="#7c3aed" stroke-width="3" stroke-dasharray="32" stroke-dashoffset="12"/>
              </svg>
              Carregando contratos...
            </div>
          </div>

          <!-- Status sync -->
          <div *ngIf="syncStatusType" class="status" [ngClass]="syncStatusType">
            <span class="status-icon">{{ syncStatusIcon }}</span>
            <span class="status-text">{{ syncStatusMessage }}</span>
          </div>

          <!-- Botão gerar -->
          <button class="btn" style="margin-top: 1.25rem;"
            [disabled]="loading || !selectedContract"
            (click)="fetchCarne(selectedContract)">
            <svg *ngIf="loading" class="spinner" viewBox="0 0 24 24" fill="none">
              <circle cx="12" cy="12" r="10" stroke="rgba(255,255,255,0.3)" stroke-width="3"/>
              <path fill="white" d="M4 12a8 8 0 018-8v8z"/>
            </svg>
            <span>{{ loading ? 'Gerando...' : 'Gerar Carnê PDF' }}</span>
            <svg *ngIf="!loading" class="btn-icon" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="7 10 12 15 17 10"/>
              <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
          </button>
        </div>

        <!-- ══ MODO MANUAL ══ -->
        <div *ngIf="mode === 'manual'">
          <div class="step">
            <div class="step-label">
              <span class="field-label">Número do Contrato</span>
            </div>
            <div class="input-wrap">
              <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
                <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
              </svg>
              <input
                type="text"
                [(ngModel)]="manualContract"
                (keydown.enter)="fetchCarne(manualContract)"
                placeholder="ex: 0001234567"
                autocomplete="off"
                class="contract-input"
              />
            </div>
          </div>

          <button class="btn" [disabled]="loading || !manualContract.trim()"
            (click)="fetchCarne(manualContract)">
            <svg *ngIf="loading" class="spinner" viewBox="0 0 24 24" fill="none">
              <circle cx="12" cy="12" r="10" stroke="rgba(255,255,255,0.3)" stroke-width="3"/>
              <path fill="white" d="M4 12a8 8 0 018-8v8z"/>
            </svg>
            <span>{{ loading ? 'Gerando...' : 'Gerar Carnê PDF' }}</span>
            <svg *ngIf="!loading" class="btn-icon" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="7 10 12 15 17 10"/>
              <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
          </button>
        </div>

        <!-- Status geral (download) -->
        <div *ngIf="statusType" class="status" [ngClass]="statusType" style="margin-top: 1rem;">
          <span class="status-icon">{{ statusIcon }}</span>
          <span class="status-text">{{ statusMessage }}</span>
        </div>

      </div>

      <!-- Footer -->
      <div class="card-footer">
        <div class="footer-badge">
          <span class="footer-dot">✦</span>
          <span>Santander Bank</span>
        </div>
      </div>
    </div>

  </div>
</div>